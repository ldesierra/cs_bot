<% if user_signed_in? %>
  <div class="min-h-screen bg-black">
    <!-- Header -->
    <div class="bg-gray-900 border-b border-gray-800">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-6">
          <div>
            <!-- Total Profit Badge -->
            <div class="bg-green-600 text-white px-4 py-3 rounded-lg font-bold flex items-center space-x-2">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
              </svg>
              <span>TOTAL PROFIT: $<%= current_user.total_profit.present? ? sprintf("%.2f", current_user.total_profit) : 0 %></span>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <!-- Off Skin Balance Badge -->
            <div class="bg-orange-500 text-black px-3 py-2 rounded-lg font-medium flex items-center space-x-2">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"></path>
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"></path>
              </svg>
              <span>Balance: $<%= current_user.balance.present? ? sprintf("%.2f", current_user.balance) : 0 %></span>
            </div>

            <%= link_to "Create Transaction", new_transaction_path, class: "bg-orange-500 hover:bg-orange-600 text-black font-medium py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 cursor-pointer" %>

            <!-- Profile Menu -->
            <div class="relative">
              <button class="flex items-center space-x-2 text-gray-300 hover:text-white transition-colors cursor-pointer" onclick="toggleProfileMenu()">
                <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center">
                  <span class="text-black font-medium text-sm"><%= current_user.email.first.upcase %></span>
                </div>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>

              <!-- Dropdown Menu -->
              <div id="profileMenu" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg border border-gray-700 z-50">
                <div class="py-1">
                  <div class="px-4 py-2 text-sm text-gray-300 border-b border-gray-700">
                    <%= current_user.email %>
                  </div>
                  <%= link_to "Edit Profile", edit_user_registration_path, class: "block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-colors cursor-pointer" %>
                  <%= link_to "Reset Offskin Balance", edit_off_skin_balance_path, class: "block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-colors cursor-pointer" %>
                  <%= link_to "Sign Out", destroy_user_session_path, method: :delete, class: "block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700 hover:text-white transition-colors cursor-pointer" %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Transactions List -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-white">Your Transaction Portfolio</h2>
        <p class="text-gray-400 mt-1">Track your trading performance and manage your items</p>

        <!-- Search Bar -->
        <div class="mt-6">
          <%= form_with url: root_path, method: :get, local: true, class: "flex items-center space-x-4" do |form| %>
            <div class="relative flex-1 max-w-md">
              <%= form.text_field :search,
                  value: @search_query,
                  placeholder: "Search transactions by item name... (Ctrl+K to focus)",
                  class: "block w-full pl-12 pr-3 py-2 border border-gray-600 rounded-md leading-5 bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:placeholder-gray-500 focus:ring-1 focus:ring-orange-500 focus:border-orange-500 sm:text-sm",
                  id: "search-input" %>
            </div>
            <%= form.submit "Search", class: "bg-orange-500 hover:bg-orange-600 text-black font-medium py-2 px-4 rounded-md transition-colors cursor-pointer" %>
            <% if @search_query.present? %>
              <%= link_to "Clear", root_path, class: "bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-md transition-colors cursor-pointer" %>
            <% end %>
          <% end %>
        </div>
      </div>

      <% if @search_query.present? %>
        <div class="mb-4">
          <p class="text-gray-300 text-sm">
            Search results for "<span class="text-orange-400 font-medium"><%= @search_query %></span>"
            (<%= @transactions.count %> <%= @transactions.count == 1 ? 'transaction' : 'transactions' %> found)
          </p>
        </div>
      <% end %>

      <% if @transactions.any? %>
        <div class="grid gap-6">
          <% @transactions.each do |transaction| %>
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 hover:bg-gray-850 transition-colors <%= 'border-orange-400 border-dotted border-2' unless transaction.sell.present? %>">
              <div class="flex justify-between items-start">
                <div class="flex-1">
                  <div class="flex items-center space-x-4 mb-3">
                    <h3 class="text-xl font-semibold text-white">
                      <%= transaction.item&.name || "Unknown Item" %>
                    </h3>
                    <span class="bg-orange-500 text-black px-2 py-1 rounded text-sm font-medium">
                      $<%= transaction.buy_price %>
                    </span>
                    <% if transaction.sell.present? %>
                      <span class="bg-green-500 text-white px-2 py-1 rounded text-sm font-medium">
                        Sold: $<%= transaction.sell %>
                      </span>
                    <% end %>
                  </div>

                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span class="text-gray-400">Float:</span>
                      <span class="text-white ml-1"><%= transaction.item&.float || "N/A" %></span>
                    </div>
                    <div>
                      <span class="text-gray-400">Fade:</span>
                      <span class="text-white ml-1"><%= transaction.item&.fade || "N/A" %>%</span>
                    </div>
                    <div>
                      <span class="text-gray-400">Blue:</span>
                      <span class="text-white ml-1"><%= transaction.item&.blue || "N/A" %>%</span>
                    </div>
                    <div>
                      <span class="text-gray-400">Date:</span>
                      <span class="text-white ml-1"><%= transaction.created_at.strftime("%m/%d/%Y") %></span>
                    </div>
                  </div>

                  <% if transaction.item&.stickers&.present? %>
                    <div class="mt-3">
                      <span class="text-gray-400 text-sm">Stickers:</span>
                      <span class="text-gray-300 text-sm ml-1"><%= transaction.item.stickers %></span>
                    </div>
                  <% end %>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col space-y-2 ml-4">
                  <% if transaction.sell.present? %>
                    <%
                      profit_loss = transaction.sell - transaction.buy_price
                      if profit_loss > 0
                    %>
                      <span class="bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-bold flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span>PROFIT: +$<%= sprintf("%.2f", profit_loss) %></span>
                      </span>
                    <% elsif profit_loss < 0 %>
                      <span class="bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-bold flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 10.293a1 1 0 010 1.414l-6 6a1 1 0 01-1.414 0l-6-6a1 1 0 111.414-1.414L9 14.586V3a1 1 0 012 0v11.586l4.293-4.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        <span>LOST: $<%= sprintf("%.2f", profit_loss.abs) %></span>
                      </span>
                    <% else %>
                      <span class="bg-gray-600 text-white px-3 py-2 rounded-lg text-sm font-bold">
                        BREAK EVEN
                      </span>
                    <% end %>
                  <% end %>

                  <% unless transaction.sell.present? %>
                    <button onclick="addSellPrice(<%= transaction.id %>)" class="bg-green-500 hover:bg-green-600 text-white text-sm font-medium py-2 px-3 rounded transition-colors cursor-pointer">
                      Add Sell Price
                    </button>
                  <% end %>
                  <%= link_to "Edit", edit_transaction_path(transaction), class: "bg-gray-600 hover:bg-gray-500 text-white text-sm font-medium py-2 px-3 rounded transition-colors text-center cursor-pointer" %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-12">
          <div class="text-gray-400 mb-4">
            <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
          </div>
          <h3 class="text-lg font-medium text-white mb-2">No transactions yet</h3>
          <p class="text-gray-400 mb-6">Get started by creating your first transaction</p>
          <%= link_to "Create Transaction", new_transaction_path, class: "bg-orange-500 hover:bg-orange-600 text-black font-medium py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 cursor-pointer" %>
        </div>
      <% end %>
    </div>

    <!-- Navigation Buttons - Bottom Left -->
    <div class="fixed bottom-6 left-6 z-40">
      <div class="flex flex-col space-y-3">
        <%= link_to hourly_sents_path, class: "bg-orange-500 hover:bg-orange-600 text-black font-medium py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 cursor-pointer shadow-lg flex items-center space-x-2" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Hourly Sents</span>
        <% end %>

        <%= link_to biddeds_path, class: "bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 cursor-pointer shadow-lg flex items-center space-x-2" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Bidded Items</span>
        <% end %>

        <%= link_to snipes_path, class: "bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 cursor-pointer shadow-lg flex items-center space-x-2" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <span>Snipes</span>
        <% end %>

        <%= link_to targets_path, class: "bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 cursor-pointer shadow-lg flex items-center space-x-2" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>Targets</span>
        <% end %>

        <%= link_to search_items_path, class: "bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 cursor-pointer shadow-lg flex items-center space-x-2" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <span>Search Items</span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Sell Price Modal -->
  <div id="sell-price-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-900 border border-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-white">Add Sell Price</h3>
        <button onclick="closeSellPriceModal()" class="text-gray-400 hover:text-white transition-colors cursor-pointer">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="mb-4">
        <label for="sell-price-input" class="block text-sm font-medium text-gray-300 mb-2">
          Sell Price ($)
        </label>
        <input
          type="number"
          id="sell-price-input"
          class="w-full px-3 py-2 border border-gray-600 placeholder-gray-400 text-white bg-gray-800 rounded-md focus:outline-none focus:ring-orange-500 focus:border-orange-500"
          placeholder="Enter sell price"
          step="0.01"
          min="0"
          onkeypress="if(event.key==='Enter') submitSellPrice()"
        >
        <input type="hidden" id="sell-transaction-id" value="">
      </div>

      <div class="flex space-x-3">
        <button
          onclick="submitSellPrice()"
          class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-md transition-colors cursor-pointer"
        >
          Add Sell Price
        </button>
        <button
          onclick="closeSellPriceModal()"
          class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 px-4 rounded-md transition-colors cursor-pointer"
        >
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- JavaScript for Profile Menu, Sell Price, and Search -->
  <script>
    function toggleProfileMenu() {
      const menu = document.getElementById('profileMenu');
      menu.classList.toggle('hidden');
    }

    // Search functionality
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('search-input');
      if (searchInput) {
        // Auto-submit search on Enter key
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            this.form.submit();
          }
        });

        // Focus search input when pressing Ctrl+K or Cmd+K
        document.addEventListener('keydown', function(e) {
          if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            searchInput.focus();
          }
        });
      }
    });

    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
      const profileMenu = document.getElementById('profileMenu');
      const profileButton = event.target.closest('button');

      if (!profileButton || !profileButton.onclick || profileButton.onclick.toString().indexOf('toggleProfileMenu') === -1) {
        profileMenu.classList.add('hidden');
      }
    });

    function addSellPrice(transactionId) {
      // Set the transaction ID for the form
      document.getElementById('sell-transaction-id').value = transactionId;

      // Show the modal
      document.getElementById('sell-price-modal').classList.remove('hidden');

      // Focus on the input field
      setTimeout(() => {
        document.getElementById('sell-price-input').focus();
      }, 100);
    }

    function closeSellPriceModal() {
      document.getElementById('sell-price-modal').classList.add('hidden');
      document.getElementById('sell-price-input').value = '';
    }

    function submitSellPrice() {
      const sellPrice = document.getElementById('sell-price-input').value;
      const transactionId = document.getElementById('sell-transaction-id').value;

      if (sellPrice && !isNaN(sellPrice) && sellPrice > 0) {
        // Create a form to submit the sell price
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/transactions/${transactionId}`;

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'authenticity_token';
        csrfInput.value = csrfToken;

        // Add Rails method override for PATCH
        const methodInput = document.createElement('input');
        methodInput.type = 'hidden';
        methodInput.name = '_method';
        methodInput.value = 'patch';

        const sellInput = document.createElement('input');
        sellInput.type = 'hidden';
        sellInput.name = 'transaction[sell]';
        sellInput.value = sellPrice;

        form.appendChild(csrfInput);
        form.appendChild(methodInput);
        form.appendChild(sellInput);
        document.body.appendChild(form);
        form.submit();
      } else {
        alert('Please enter a valid sell price');
      }
    }

    // Close modal when clicking outside
    document.getElementById('sell-price-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeSellPriceModal();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeSellPriceModal();
      }
    });
  </script>
<% else %>
  <!-- Sign in page for non-authenticated users -->
  <div class="min-h-screen bg-black flex items-center justify-center">
    <div class="text-center">
      <h1 class="text-4xl font-bold text-white mb-4">Welcome to CS</h1>
      <p class="text-gray-400 mb-8">Your premium trading platform</p>

      <div class="space-x-4">
        <%= link_to "Sign In", new_user_session_path, class: "bg-orange-500 hover:bg-orange-600 text-black font-medium py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 cursor-pointer" %>
        <%= link_to "Sign Up", new_user_registration_path, class: "bg-gray-800 hover:bg-gray-700 text-white font-medium py-3 px-6 rounded-lg transition-all duration-200 cursor-pointer" %>
      </div>
    </div>
  </div>
<% end %>

